---
title: "Evapotranspiration EDA"
subtitle: "EAS 520"
author: "Ronny Hernández Mora"
date: "2/27/2021"
always_allow_html: yes
output:
  rmdformats::downcute:
    code_folding: hide
    fig_width: 8
    fig_height: 4
    use_bookdown: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(janitor)
library(visdat)
library(bigleaf)
library(lubridate)
library(gt)
library(tidyr)
library(purrr)
library(rmdformats)

# Number output options
options(scipen = 20)
options(Sys.getlocale("LC_CTYPE"))
```

# Import data

We are going to import three datasets that comes from the Enviro-Net open-data
platform. This data sets are:

 - carbon_tower_streams: Data from the Carbon Tower that it's from the streams
 sensor station
 - carbon_tower_eddy: Data from the Carbon Tower that it's from the Eddy Co.
 sensor station
 - principe_tower_eddy: Data from the Principe Tower that it's from the Eddy Co.
 sensor station
```{r}
carbon_tower_streams <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_Streams_Streams(12345)_20181228_20190128.csv") %>% 
  clean_names()

carbon_tower_eddy <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_EddyCo._CampbellCR3000(1)_20130607_20190512.csv") %>% 
  clean_names()

principe_tower_eddy <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_PrincipeTower(New)_EddyCo._CampbellCR3000(2)_20151213_20190622.csv") %>% 
  clean_names()
```

# carbon_tower_streams EDA

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** Even if you select a date range from 2013 to present in the 
enviro-net portal, there are just two months available to retrieve.

## Evapotranspiration EDA from streams

First we check the months and years available in the data set: 
```{r}
carbon_tower_streams %>% 
  mutate(date = as_date(date_time)) %>% 
  group_by(year(date), month(date)) %>% 
  tally() %>% 
  ungroup() %>% 
  rename("Year" = `year(date)`,
         "Month" = `month(date)`,
         "Total observations" = "n") %>% 
  gt() %>% 
  tab_header(
    title = md("**Total observations per date**"),
    subtitle = ("For the carbon tower data streams")
  ) 
```

<br> 
The date range we have available is `r range(carbon_tower_streams$date_time, na.rm = TRUE)`,
that's just one month.

```{r}
# Evapotranspiration
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")

# day <- interval(hms("06:00:00"), hms("17:30:00"))
# carbon_tower_streams %>%
#   mutate(day = ifelse(hms(date_time) > hms("06:00:00") & 
#                         hms(date_time) > hms("17:00:00"), 
#                       "dia", "noche")) %>%
#   select(date_time, day) %>%  View()
```


```{r}
carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  ggplot(aes(x = date, y = evapotranspiration, colour = day)) +
  geom_jitter(alpha = 0.5, size = 2) +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.02)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       subtitle = "Day defined as the interval of date time from 05:20:00 to 17:20:00",
       x = "Date", 
       y = "Evapotranspiration kg m-2 s-1",
       fill = "Day period")
```

There are some values with high latent_heat_flux and thus high evapotranspiration
values in the night. Is this normal or is due to an error?

I defined day as those observations between the `date_time > 05:20:00` and 
`date_time 17:20:00` in order to check this values
```{r check night values, eval = FALSE, fig.width=10}
# Check nigth values with evapotranspiration close to day values
## above 0.04 we can try to explore those values in the nigth category
carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  filter(evapotranspiration > 0.04) %>% 
  DT::datatable(
    rownames = FALSE,
    extensions = 'Buttons',
    selection = list(mode = 'single', target = 'row'),
    options = list(
      lengthMenu = list(c(20, 50, 100, -1), c('20', '50', '100', 'All')),
      dom = 'Bflp',
      buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
      scrollX = T)) 
```


```{r}
# Revisión de datos de evapotranspiracion y latent heat
check <- carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  mutate(eva_plus = ifelse(evapotranspiration > 0.04, "high", "low"))

# ¿Qué características tienen los puntos de noche con eva > 0.04?
check %>% 
  select(time, day, evapotranspiration, latent_heat_flux) %>% 
  head(15) %>% 
  gt()
# Notar que el latent heat flux es la multiplicacion de
# evapotranspiracion * mil

# check %>% 
#   # filter(eva_plus == "high") %>% 
#   ggplot(aes(x = evapotranspiration, y = latent_heat_flux, colour = day)) +
#   geom_jitter(alpha = 0.3, size = 2) +
#   theme_light()
```

## Exploration of other variables behaviour trough dates availables

This are some plots to explore and understand the behaviour of other variables
in the dataset `carbon_tower_streams` trough time.
```{r}
# Water vapor mass density carbon
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = ambient_water_vapor_mass_density)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Water vapor mass density carbon tower Santa Rosa",
       x = "Date", y = "Water vapor mass density carbon")
```


```{r}
# Latent heat flux
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = latent_heat_flux)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Latent heat flux carbon tower Santa Rosa",
       x = "Date", y = "Latent heat flux")
```


```{r}
# Net ecosystem exchange
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Net ecosystem exchange carbon tower Santa Rosa",
       x = "Date", y = "Net ecosystem exchange mmol m2 s1")
```

## Relations between variables

Just to understand evapotranspiration behaviour against other variables
```{r}
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(y = evapotranspiration, 
             x = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(y = evapotranspiration, 
             x = latent_heat_flux)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(y = evapotranspiration, 
             x = ambient_water_vapor_mass_density)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()
```

```{r}
# carbon_tower_streams %>% 
#   separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
#   mutate(day_nigth = ifelse()) %>%
```

# carbon_tower_eddy eda

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** 

```{r}
# Select variables to play with
eddy <- carbon_tower_eddy %>% 
  select(date_time, sensible_heat_flux, co2_flux, latent_heat_flux,
         mean_co2_concentration, mean_h2o_vapour_concentration, 
         mean_moist_air_density, mean_thermocouple_temp)

# Check available dates in the data set
eddy %>% 
  group_by(year(date_time), month(date_time, 
                                  label = TRUE,
                                  locale = Sys.getlocale("LC_CTYPE"))) %>% 
  tally() %>% 
  rename(
    Year = `year(date_time)`,
    Month = `month(date_time, label = TRUE, locale = Sys.getlocale("LC_CTYPE"))`,
    Observations = "n"
  ) %>% 
  gt() %>% 
  tab_header(
    title = md("**Total of observations per year and month**"),
    subtitle = ("For the carbon tower eddy data")
  ) %>% 
  fmt_number(columns = vars(Observations),
             decimals = 0,
             use_seps = TRUE) %>% 
  data_color(
    columns = vars(Month),
    colors = scales::col_factor("Spectral", domain = NULL)
  )

# Por mes agregado por año
eddy %>% 
  group_by(year(date_time), month(date_time)) %>% 
  tally() %>% 
  ggplot(aes(x = as.factor(`month(date_time)`),
             y = n, 
             fill = as.factor(`year(date_time)`))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12)

# Separados por mes y por año
eddy %>% 
  group_by(zoo::as.yearmon(date_time)) %>% 
  tally() %>% 
  rename("date" = `zoo::as.yearmon(date_time)`, "total" = "n") %>% 
  ggplot(aes(x = as.factor(date),
             y = total, 
             fill = as.factor(year(date)))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 70, h = 1))
```

## Evapotranspiracion calculation with bigleafR

<!-- For bigleafR function we need latent heat and air temperature with -->
<!-- LE of 200 Wm-2 and air temperature of 25degC `LE.to.ET(200, 25)` -->

We can obtain evapotranspiration with the `bigleafR` function, in which we
can use Latent Heat Flux (W m-2) with Air Temperature (C) to obtain
evapotranspiracion (kg m-2 s-1)
```{r}
evapotranspiration <- eddy %>% 
  mutate(evapotranspiration = LE.to.ET(latent_heat_flux,
                                       mean_thermocouple_temp))
```

With the dataset `carbon_tomer_streams` we saw that there is a strong
correlation between `latent_heat_flux` and `evapotranspiration` and it's
basically `latent_heat_flux * 1000`. I want to check if this is the same
with the results obtained using the bigleafR package:
```{r}
evapotranspiration %>% 
  select(latent_heat_flux, evapotranspiration) %>% 
  head(20) %>% 
  gt() %>% 
  tab_header(
    title = md("**Comparison of Latent Heat Flux with Evapotranspiration**"),
    subtitle = "For the Carbon Tower eddy data"
  ) %>% 
  tab_footnote(
     footnote = "Shows only the first 20 observations",
     locations = cells_column_labels(
       columns = vars(latent_heat_flux, evapotranspiration)
     )
  )
```

## Exploratory visualizations from eddy

 - Plot with all the evapotranspiration data points from 2013 to 2019
 - There is no data for 2018 and only 3 months for 2019
```{r}
evapotranspiration %>% 
  mutate(date = ymd_hms(date_time)) %>%
  # filter values above 0.05
  filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>% 
  # filter(year(date_time) == 2013) %>% 
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b", breaks = "months") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       subtitle = "Al the datapoints available",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")
```

```{r}
plot_evapotranspiration <- function(data, year) {
  data %>%
    mutate(date = ymd_hms(date_time),
           year = year(date_time)) %>%
    # filter values above 0.05
    filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>%
    filter(year == !!year) %>%
    ggplot(aes(x = date_time, y = evapotranspiration)) +
    geom_point(alpha = 0.5) +
    # geom_line() +
    scale_x_datetime(date_labels = "%b", breaks = "months") +
    theme_light() +
    theme(axis.text.x = element_text(angle = 75, h = 1)) +
    labs(title = "Evapotranspiration carbon tower Santa Rosa",
         subtitle = paste("With all the datapoints available for", year),
         x = "Date", y = "Evapotranspiration kg m-2 s-1")
}

## Get years
years <- evapotranspiration %>% 
  transmute(year = year(date_time)) %>% 
  distinct() %>% 
  pull()

# Map to get all plots
map(.x = years, .f = function(plots) {
  evapotranspiration %>% 
    plot_evapotranspiration(year = plots)
})
```

# principe_tower_eddy EDA

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** The data available in enviro-net from this tower does not contains
`stream data`. But it does have the variable `air_temperature`

```{r}
# Select variables to play with
eddy <- principe_tower_eddy %>% 
  select(date_time, sensible_heat_flux, co2_flux, latent_heat_flux,
         mean_co2_concentration, mean_h2o_vapour_concentration, 
         mean_moist_air_density, mean_thermocouple_temp,
         air_temperature)

# Check available dates in the data set
eddy %>% 
  group_by(year(date_time), month(date_time, 
                                  label = TRUE,
                                  locale = Sys.getlocale("LC_CTYPE"))) %>% 
  tally() %>% 
  rename(
    Year = `year(date_time)`,
    Month = `month(date_time, label = TRUE, locale = Sys.getlocale("LC_CTYPE"))`,
    Observations = "n"
  ) %>% 
  gt() %>% 
  tab_header(
    title = md("**Total of observations per year and month**"),
    subtitle = ("For the Principe tower eddy data")
  ) %>% 
  fmt_number(columns = vars(Observations),
             decimals = 0,
             use_seps = TRUE) %>% 
  data_color(
    columns = vars(Month),
    colors = scales::col_factor("Spectral", domain = NULL)
  )

# Por mes agregado por año
eddy %>% 
  group_by(year(date_time), month(date_time)) %>% 
  tally() %>% 
  ggplot(aes(x = as.factor(`month(date_time)`),
             y = n, 
             fill = as.factor(`year(date_time)`))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12)

# Separados por mes y por año
eddy %>% 
  group_by(zoo::as.yearmon(date_time)) %>% 
  tally() %>% 
  rename("date" = `zoo::as.yearmon(date_time)`, "total" = "n") %>% 
  ggplot(aes(x = as.factor(date),
             y = total, 
             fill = as.factor(year(date)))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 70, h = 1))
```

## Evapotranspiracion calculation with bigleafR

<!-- For bigleafR function we need latent heat and air temperature with -->
<!-- LE of 200 Wm-2 and air temperature of 25degC `LE.to.ET(200, 25)` -->

```{r}
evapotranspiration <- eddy %>% 
  mutate(evapotranspiration = LE.to.ET(latent_heat_flux,
                                       air_temperature))
```

```{r}
evapotranspiration %>% 
  select(latent_heat_flux, evapotranspiration) %>% 
  head(20) %>% 
  gt() %>% 
  tab_header(
    title = md("**Comparison of Latent Heat Flux with Evapotranspiration**"),
    subtitle = "For the Principe tower eddy data"
  ) %>% 
  tab_footnote(
     footnote = "Shows only the first 20 observations",
     locations = cells_column_labels(
       columns = vars(latent_heat_flux, evapotranspiration)
     )
  )
```

## Exploratory visualizations from eddy

 - Plot with al the data points of evapotranspiration from 2013 to 2019
 - There is no data for 2018 and only 3 months for 2019
```{r}
evapotranspiration %>% 
  mutate(date = ymd_hms(date_time)) %>%
  # filter values above 0.05
  filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>% 
  # filter(year(date_time) == 2013) %>% 
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b", breaks = "months") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Evapotranspiration Principe tower Santa Rosa",
       subtitle = "Al the datapoints available",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")
```

```{r, message = FALSE}
plot_evapotranspiration <- function(data, year) {
  data %>%
    mutate(date = ymd_hms(date_time),
           year = year(date_time)) %>%
    # filter values above 0.05
    filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>%
    filter(year == !!year) %>%
    ggplot(aes(x = date_time, y = evapotranspiration)) +
    geom_point(alpha = 0.5) +
    # geom_line() +
    scale_x_datetime(date_labels = "%b", breaks = "months") +
    theme_light() +
    theme(axis.text.x = element_text(angle = 75, h = 1)) +
    labs(title = "Evapotranspiration Principe tower Santa Rosa",
         subtitle = paste("With all the datapoints available for", year),
         x = "Date", y = "Evapotranspiration kg m-2 s-1")
}

## Get years
years <- evapotranspiration %>% 
  transmute(year = year(date_time)) %>% 
  distinct() %>% 
  pull()

# Map to get all plots
map(.x = years, .f = function(plots) {
  evapotranspiration %>% 
    plot_evapotranspiration(year = plots)
})
```

# Notes on calculating real evapotranspiration

 - It looks that the function `LE.to.ET` from the `bigleaf` R package calculates
 potential evapotranspiration rather than real evapotranspiration. My guess is
 because we only need Latent Heat Flux and Air Temperature to calculate this, but
 the problem is that at least in Santa Rosa we have a dry season were there is
 almost no rain, and if there is no water, there is not going to be evaporation
 and transpiration.

