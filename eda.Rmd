---
title: "Evapotranspiration EDA"
subtitle: "EAS 520"
author: "Ronny Hernández Mora"
date: "2/27/2021"
always_allow_html: yes
output:
  html_document:
    code_folding: hide
    self_contained: true
    number_sections: no
    theme: spacelab
    toc: yes
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(janitor)
library(visdat)
library(bigleaf)
library(lubridate)
library(gt)
library(tidyr)
```

# Import data

```{r}
carbon_tower_streams <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_Streams_Streams(12345)_20181228_20190128.csv") %>% 
  clean_names()

carbon_tower_eddy <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_EddyCo._CampbellCR3000(1)_20130607_20190512.csv") %>% 
  clean_names()
```

## Carbon tower streams

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** Even if you select a date range from 2013 to present in the 
enviro-net portal, there are just two months available to retrieve.

### Evapotranspiration EDA from streams

First we check the months and years available in the data set:
```{r}
carbon_tower_streams %>% 
  mutate(date = as_date(date_time)) %>% 
  group_by(year(date), month(date)) %>% 
  tally() %>% 
  gt()
```

The date range we have available is `r range(carbon_tower_streams$date_time, na.rm = TRUE)`

```{r}
# Evapotranspiration
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")

# day <- interval(hms("06:00:00"), hms("17:30:00"))
carbon_tower_streams %>% 
  mutate(day = ifelse(hms(date_time) > hms("06:00:00") & hms(date_time) > hms("17:00:00"), "dia", "noche")) %>% 
  select(date_time, day) %>%  View()

carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  ggplot(aes(x = date, y = evapotranspiration, colour = day)) +
  geom_jitter(alpha = 0.5, size = 2) +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.02)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")

# Check nigth values with evapotranspiration close to day values
## above 0.04 we can try to explore those values in the nigth category
carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  filter(evapotranspiration > 0.04) %>% 
  View()

# Revisión de datos de evapotranspiracion y latent heat
check <- carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  mutate(eva_plus = ifelse(evapotranspiration > 0.04, "high", "low"))

# ¿Qué características tienen los puntos de noche con eva > 0.04?
check %>% 
  select(time, day, evapotranspiration, latent_heat_flux) %>% 
  View() # Notar que el latent heat flux es la multiplicacion de
# evapotranspiracion * mil

check %>% 
  # filter(eva_plus == "high") %>% 
  ggplot(aes(x = evapotranspiration, y = latent_heat_flux, colour = day)) +
  geom_jitter(alpha = 0.3)

# Water vapor mass density carbon
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = ambient_water_vapor_mass_density)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Water vapor mass density carbon tower Santa Rosa",
       x = "Date", y = "Water vapor mass density carbon")

# Latent heat flux
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = latent_heat_flux)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Latent heat flux carbon tower Santa Rosa",
       x = "Date", y = "Latent heat flux")

# Net ecosystem exchange
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Net ecosystem exchange carbon tower Santa Rosa",
       x = "Date", y = "Net ecosystem exchange mmol m2 s1")
```

### Relations between variables

Just to understand evapotranspiration behavious against other variables
```{r}
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = latent_heat_flux)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = ambient_water_vapor_mass_density)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()
```

```{r}
# carbon_tower_streams %>% 
#   separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
#   mutate(day_nigth = ifelse()) %>%
```

## Carbon tower eddy

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** 

```{r}
eddy <- carbon_tower_eddy %>% 
  select(date_time, sensible_heat_flux, co2_flux, latent_heat_flux,
         mean_co2_concentration, mean_h2o_vapour_concentration, 
         mean_moist_air_density, mean_thermocouple_temp)
```

## Calculo de evapotranspiracion con bigleafR

<!-- For bigleafR function we need latent heat and air temperature with -->
<!-- LE of 200 Wm-2 and air temperature of 25degC `LE.to.ET(200, 25)` -->

Evapotranspiracion se puede sacar con la siguiente funcion, donde convierte
Latent Heat Flux (W m-2) con Air Temperature (C) a evapotranspiracion (kg m-2 s-1)

```{r}
evapotranspiration <- eddy %>% 
  mutate(evapotranspiration = LE.to.ET(latent_heat_flux,
                                       mean_thermocouple_temp))
```

### Exploratory visualizations from eddy

```{r}
## Grafico solo imprime enero. Vamos a tomar solo un año
# evapotranspiration %>%
#   mutate(date = ymd_hms(date_time)) %>%
#   # filter values above 0.05
#   filter(evapotranspiration < 0.05) %>% 
#   ggplot(aes(x = date_time, y = evapotranspiration)) +
#   geom_point() +
#   # Si tenemos datetime, cambiamos el scale_x
#   scale_x_datetime(date_labels = "%b") +
#   theme_light() +
#   theme(axis.text.x = element_text(angle = 90)) +
#   labs(title = "Evapotranspiration carbon tower Santa Rosa",
#        x = "Date", y = "Evapotranspiration kg m-2 s-1") +
#   facet_wrap(~year(date_time))

## Filtering just one year

```


# Preguntas

 - Idea es usar variable evapotranspiración del conjunto `carbon_tower_streams` o calcularla de alguna manera con los datos del
 conjunto `carbon_tower_flux`
   - Si debo de calcularla del último, ¿cuál es la manera correcta? 
   Referir a funciones de paquete `bigleafR`
 - Al calcular la evapotranspiración buscamos relacionarla con otras
 variables o la idea es buscar fenómenos como sequías, temporales etc?
 - ¿Dónde puedo ver las unidades en que están las mediciones?
 - Pregunta para reunión más larga: ¿Cuál es el proceso de los datos desde
 los sensores de las torres hasta environet?
 - Ver los datos de stream donde la evapotranspiracion es la division de
 latent heat flux en mil.
 - ¿La temperatura del aire es la que obtengo con el mean_thermocouple_temp?

## Notas

Evapotranspiration can be computed as reference, potential, or actual 
evapotranspiration.   Reference evapotranspiration is that from a grass surface 
that is well-watered.  Potential evapotranspiration is that from a surface that 
has unlimited water (such as a lake). Tomado de (aquí)[https://www.usgs.gov/centers/car-fl-water/science/reference-and-potential-evapotranspiration?qt-science_center_objects=0#qt-science_center_objects]