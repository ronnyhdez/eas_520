---
title: "Evapotranspiration EDA"
subtitle: "EAS 520"
author: "Ronny Hernández Mora"
date: "2/27/2021"
always_allow_html: yes
output:
  html_document:
    code_folding: hide
    self_contained: true
    number_sections: no
    theme: spacelab
    toc: yes
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(janitor)
library(visdat)
library(bigleaf)
library(lubridate)
library(gt)
library(tidyr)
```

# Import data

```{r}
carbon_tower_streams <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_Streams_Streams(12345)_20181228_20190128.csv") %>% 
  clean_names()

carbon_tower_eddy <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_EddyCo._CampbellCR3000(1)_20130607_20190512.csv") %>% 
  clean_names()
```

## Carbon tower streams

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** Even if you select a date range from 2013 to present in the 
enviro-net portal, there are just two months available to retrieve.

### Evapotranspiration EDA from streams

First we check the months and years available in the data set: 
```{r}
carbon_tower_streams %>% 
  mutate(date = as_date(date_time)) %>% 
  group_by(year(date), month(date)) %>% 
  tally() %>% 
  ungroup() %>% 
  rename("Year" = `year(date)`,
         "Month" = `month(date)`,
         "Total observations" = "n") %>% 
  gt()
```

<br> 
The date range we have available is `r range(carbon_tower_streams$date_time, na.rm = TRUE)`,
that's just one month.

```{r}
# Evapotranspiration
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")

# day <- interval(hms("06:00:00"), hms("17:30:00"))
# carbon_tower_streams %>%
#   mutate(day = ifelse(hms(date_time) > hms("06:00:00") & 
#                         hms(date_time) > hms("17:00:00"), 
#                       "dia", "noche")) %>%
#   select(date_time, day) %>%  View()
```


```{r}
carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  ggplot(aes(x = date, y = evapotranspiration, colour = day)) +
  geom_jitter(alpha = 0.5, size = 2) +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.02)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       subtitle = "Day defined as the interval of date time from 05:20:00 to 17:20:00",
       x = "Date", 
       y = "Evapotranspiration kg m-2 s-1",
       fill = "Day period")
```

There are some values with high latent_heat_flux and thus high evapotranspiration
values in the night. Is this normal or is due to an error?

I defined day as those observations between the `date_time > 05:20:00` and 
`date_time 17:20:00` in order to check this values
```{r check night values}
# Check nigth values with evapotranspiration close to day values
## above 0.04 we can try to explore those values in the nigth category
carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  filter(evapotranspiration > 0.04) %>% 
  DT::datatable()
```


```{r}
# Revisión de datos de evapotranspiracion y latent heat
check <- carbon_tower_streams %>% 
  separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = hms(time),
         day = ifelse(hms(time) > hms("05:20:00") & 
                        hms(time) < hms("17:20:00"),
                      "day", "nigth")) %>%
  replace_na(list(day = "nigth")) %>% 
  mutate(eva_plus = ifelse(evapotranspiration > 0.04, "high", "low"))

# ¿Qué características tienen los puntos de noche con eva > 0.04?
check %>% 
  select(time, day, evapotranspiration, latent_heat_flux) %>% 
  head(15) %>% 
  gt()
# Notar que el latent heat flux es la multiplicacion de
# evapotranspiracion * mil

check %>% 
  # filter(eva_plus == "high") %>% 
  ggplot(aes(x = evapotranspiration, y = latent_heat_flux, colour = day)) +
  geom_jitter(alpha = 0.3, size = 2) +
  theme_light()
```

### Exploration of other variables behaviour trough dates availables

This are some plots to explore and understand the behaviour of other variables
in the dataset `carbon_tower_streams` trough time.
```{r}
# Water vapor mass density carbon
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = ambient_water_vapor_mass_density)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Water vapor mass density carbon tower Santa Rosa",
       x = "Date", y = "Water vapor mass density carbon")
```


```{r}
# Latent heat flux
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = latent_heat_flux)) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Latent heat flux carbon tower Santa Rosa",
       x = "Date", y = "Latent heat flux")
```


```{r}
# Net ecosystem exchange
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_line() +
  # Si tenemos datetime, cambiamos el scale_x
  scale_x_datetime(date_labels = "%d-%b-%Y",  date_breaks = "1 day") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Net ecosystem exchange carbon tower Santa Rosa",
       x = "Date", y = "Net ecosystem exchange mmol m2 s1")
```

### Relations between variables

Just to understand evapotranspiration behaviour against other variables
```{r}
carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = net_ecosystem_exchange_mmol_m_2_s_1 )) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = latent_heat_flux)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()

carbon_tower_streams %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = evapotranspiration, 
             y = ambient_water_vapor_mass_density)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()
```

```{r}
# carbon_tower_streams %>% 
#   separate(col = date_time, into = c("date", "time"), sep = " ") %>% 
#   mutate(day_nigth = ifelse()) %>%
```

## Carbon tower eddy

In order to understand the structure of the data set please check the
**DICTIONARY file**

**Note** 

```{r}
# Select variables to play with
eddy <- carbon_tower_eddy %>% 
  select(date_time, sensible_heat_flux, co2_flux, latent_heat_flux,
         mean_co2_concentration, mean_h2o_vapour_concentration, 
         mean_moist_air_density, mean_thermocouple_temp)

# Check available dates in the data set
eddy %>% 
  group_by(year(date_time), month(date_time)) %>% 
  tally() %>% 
  gt()

# Por mes agregado por año
eddy %>% 
  group_by(year(date_time), month(date_time)) %>% 
  tally() %>% 
  ggplot(aes(x = as.factor(`month(date_time)`),
             y = n, 
             fill = as.factor(`year(date_time)`))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12)

# Separados por mes y por año
eddy %>% 
  group_by(zoo::as.yearmon(date_time)) %>% 
  tally() %>% 
  rename("date" = `zoo::as.yearmon(date_time)`, "total" = "n") %>% 
  ggplot(aes(x = as.factor(date),
             y = total, 
             fill = as.factor(year(date)))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 70, h = 1))
```

### Evapotranspiracion calculation with bigleafR

<!-- For bigleafR function we need latent heat and air temperature with -->
<!-- LE of 200 Wm-2 and air temperature of 25degC `LE.to.ET(200, 25)` -->

We can obtain evapotranspiration with the `bigleafR` function, in which we
can use Latent Heat Flux (W m-2) with Air Temperature (C) to obtain
evapotranspiracion (kg m-2 s-1)
```{r}
evapotranspiration <- eddy %>% 
  mutate(evapotranspiration = LE.to.ET(latent_heat_flux,
                                       mean_thermocouple_temp))
```

With the dataset `carbon_tomer_streams` we saw that there is a strong
correlation between `latent_heat_flux` and `evapotranspiration` and it's
basically `latent_heat_flux * 1000`. I want to check if this is the same
with the results obtained using the bigleafR package:
```{r}
evapotranspiration %>% 
  select(latent_heat_flux, evapotranspiration) %>% 
  head(20) %>% 
  gt()


```

### Exploratory visualizations from eddy

 - Plot with al the data points of evapotranspiration from 2013 to 2019
 - There is no data for 2018 and only 3 months for 2019
```{r}
evapotranspiration %>% 
  mutate(date = ymd_hms(date_time)) %>%
  # filter values above 0.05
  filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>% 
  # filter(year(date_time) == 2013) %>% 
  ggplot(aes(x = date_time, y = evapotranspiration)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b", breaks = "months") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Evapotranspiration carbon tower Santa Rosa",
       x = "Date", y = "Evapotranspiration kg m-2 s-1")
```

# Preguntas

 - Idea es usar variable evapotranspiración del conjunto `carbon_tower_streams`
 o calcularla de alguna manera con los datos del conjunto `carbon_tower_flux`
   - Si debo de calcularla del último, ¿cuál es la manera correcta? 
   Referir a funciones de paquete `bigleafR`
 - En las instrucciones dadas por Arturo, dice que debo de hacer: "estimation of
 real evapotranspiration using eddy covariance systems and use Enviro-Net 
 generated data to produce a code in R that will be able to estimate 
 evapotranspiration", lo que me lleva a la pregunta si ¿es únicamente un proceso
 de R con la revisión de literatura o debo de realizar un análisis estadístico
 para validar algún fenónemo? (revisar efectos climáticos de sequía por ejemplo 
 o solo revisar si con R podemos calcular evapotranspiración, algo similar a
 los papers de R)
 - Al calcular la evapotranspiración buscamos relacionarla con otras
 variables o la idea es buscar fenómenos como sequías, temporales etc?
 - ¿Dónde puedo ver las unidades en que están las mediciones?
 - Pregunta para reunión más larga: ¿Cuál es el proceso de los datos desde
 los sensores de las torres hasta environet?
 - Ver los datos de stream donde la evapotranspiracion es la division de
 latent heat flux en mil.
 - ¿La temperatura del aire es la que obtengo con el mean_thermocouple_temp?

## Notas

Evapotranspiration can be computed as reference, potential, or actual 
evapotranspiration.   Reference evapotranspiration is that from a grass surface 
that is well-watered.  Potential evapotranspiration is that from a surface that 
has unlimited water (such as a lake). Tomado de (aquí)[https://www.usgs.gov/centers/car-fl-water/science/reference-and-potential-evapotranspiration?qt-science_center_objects=0#qt-science_center_objects]