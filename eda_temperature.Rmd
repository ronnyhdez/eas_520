---
title: "EDA Temperature"
author: "Ronny Hern√°ndez Mora"
date: "2/27/2021"
always_allow_html: yes
output:
  rmdformats::downcute:
    code_folding: hide
    fig_width: 12
    fig_height: 8
    use_bookdown: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(lubridate)
library(janitor)
library(readr)
library(tidyr)
library(stringr)
library(ggplot2)
```

# Data

For this exploration we are using the datasets that are filtered from errors
using the option in the enviro-net platform.

Also I downloaded the temperature dataset from the sensors in the towers, with
the following options:

![](img/temp_1.png)
![](img/temp_2.png)

```{r}
temperature_orig <- read_csv("data/COSTA RICA - Santa Rosa National Park, Guanacaste.csv") %>% 
  clean_names()

# Read carbon tower data with error removal
carbon_tower_eddy_error_removal <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_CarbonTower(New)_EddyCo._CampbellCR3000(1)_20130607_20190512_error_removal.csv") %>% 
  clean_names()

# Read principe tower data with error removal
principe_tower_eddy_error_removal <- read_csv("data/COSTARICA-SantaRosaNationalPark,Guanacaste_PrincipeTower(New)_EddyCo._CampbellCR3000(2)_20151213_20190622_error_removal.csv") %>% 
  clean_names()
```

**Notes on datasets**
 
  - All datapoints are on 30 min intervals

# Temperature values

We have three options to use temperature values:

 - Using the values from `mean_thermocouple_temp`
 - Using the values from `temperature` variable available in the principe dataset
 - Using the values from `temperature` from the sensors data set

First I want to check how correlated the values are between the datasets. First
I need to wrangle the dates in order to join datasets. For this, I'm going to
do a check on the data points from each of the datasets that we have available.

```{r}
temp_1 <- temperature_orig %>%
  select(-air_temperature_1) %>%
  filter(!is.na(air_temperature_2)) %>%
  rename("temperature" = "air_temperature_2")

temp_2 <- temperature_orig %>%
  select(-air_temperature_2) %>%
  filter(!is.na(air_temperature_1)) %>%
  rename("temperature" = "air_temperature_1")

temp_total <- bind_rows(temp_1, temp_2) %>% nrow()
  
# Darle vuelta a variables y quitar repetidos que son NA's
temperature_converted <- temperature_orig %>% 
  pivot_longer(cols = c("air_temperature_1", "air_temperature_2"),
               names_to = "temperature") %>% 
  filter(!is.na(value)) %>% 
  separate(time_stamp, into = c("date", "time"), sep = " ") %>% 
  mutate(time = str_sub(time, start = 1, end = 5)) %>% 
  unite(col = date_time, date, time, sep = " ") %>% 
  mutate(date_time = ymd_hm(date_time)) %>% 
  select(-temperature) %>% 
  rename("temperature" = "value")
  
temp_converted <- nrow(temperature_converted)

stopifnot(temp_total == temp_converted)
rm(temp_total, temp_converted)
```

# Temperature dataset

```{r}
temperature_converted %>% 
  group_by(zoo::as.yearmon(date_time)) %>% 
  tally() %>% 
  rename("date" = `zoo::as.yearmon(date_time)`, "total" = "n") %>% 
  ggplot(aes(x = as.factor(date),
             y = total, 
             fill = as.factor(year(date)))) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light(base_size = 21) +
  labs(x = "Date", y = "Total observations", fill = "Year") +
  theme(axis.text.x = element_text(angle = 70, h = 1))
```

```{r}
temperature_converted %>% 
  mutate(date = ymd_hms(date_time)) %>%
  # filter values above 0.05
  # filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>% 
  # filter(year(date_time) == 2013) %>% 
  ggplot(aes(x = date_time, y = temperature)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b", breaks = "months") +
  theme_light(base_size = 16) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Temperature",
       subtitle = "All the datapoints available from sensor dataset",
       x = "Date", y = "Temperature")
```


## Temperature from principe tower dataset

```{r}
principe_tower_eddy_error_removal %>% 
  select(date_time, air_temperature, mean_thermocouple_temp) %>% 
  pivot_longer(cols = c("air_temperature", "mean_thermocouple_temp"),
               names_to = "temperature_origin") %>% 
  filter(!is.na(value)) %>% 
  separate(date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(time = str_sub(time, start = 1, end = 5)) %>% 
  unite(col = date_time, date, time, sep = " ") %>% 
  mutate(date_time = ymd_hm(date_time)) %>% 
  rename("temperature" = "value") %>% 
  mutate(date = ymd_hms(date_time)) %>%
  ggplot(aes(x = date_time, y = temperature, color = temperature_origin)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b%Y", breaks = "months") +
  theme_light(base_size = 16) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Temperature from two variables within the principe tower dataset",
       subtitle = "Datapoints are showed with hour and minutes per day",
       x = "Date", y = "Temperature")
```


## Temperature from carbon tower data set

```{r}

```



## Idea comparacion temperaturas y rangos

Puedo unir todas las temperaturas de los conjuntos de datos y hacer un grafico
como el siguiente donde tengo los data points por color del conjunto de datos
al que pertenecen: 

```{r, eval = FALSE}
temperature_converted %>% 
  mutate(date = ymd_hms(date_time)) %>%
  # filter values above 0.05
  # filter(evapotranspiration < 0.02 & evapotranspiration > -0.02) %>% 
  # filter(year(date_time) == 2013) %>% 
  ggplot(aes(x = date_time, y = temperature)) +
  geom_point(alpha = 0.5) +
  scale_x_datetime(date_labels = "%b", breaks = "months") +
  theme_light(base_size = 16) +
  theme(axis.text.x = element_text(angle = 75, h = 1)) +
  labs(title = "Temperature",
       subtitle = "All the datapoints available from sensor dataset",
       x = "Date", y = "Temperature")
```